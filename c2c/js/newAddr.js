require(["jquery","utils","dot"],function(a,b,c){"use strict";var d={init:function(){d.getRsaPublicKey(),d.addClick(),d.listenInputChange(),d.listenSaveBtnStatu()},para:{rsaPublicKey:"",index:"",name:"",mobile:"",addressDetail:"",addressDefault:!1,provinceId:0,cityId:0,countryId:0,townId:0,provinceName:"",cityName:"",countryName:"",townName:"",tempDefault:!1},addClick:function(){a(".ui-area").unbind("click").bind("click",function(){d.addressInit(),a(".ui-area-value").addClass("ui-area-value-grey")}),a(".btn-img").unbind("click").bind("click",function(){a(this).hide().siblings().show(),"none"==a(".btn-img").css("display")?(d.para.addressDefault=!1,d.para.tempDefault=!1):(d.para.index=0,d.para.addressDefault=!0,d.para.tempDefault=!0)}),a(".ui-address .title div").unbind("click").on("click",function(){a(this).addClass("selected").siblings().removeClass("selected");var b=a(this).index();a(".list").addClass("hide").eq(b).removeClass("hide")}),a(".ui-address .province-list").delegate(".province-name","click",function(){var b=a(this).attr("value"),c=a(this).attr("name");a(".ui-address .province").html(a(this).text()),a(".ui-address .county").hide(),a(this).addClass("selected").removeClass("hide").siblings().removeClass("selected"),a(".province-list .font-item").hide(),a(this).find(".font-item").show(),d.getCityList(b),d.listenSaveBtnStatu(),d.para.provinceId=b,d.para.provinceName=c}),a(".ui-address .city-list").delegate(".city-name","click",function(){var b=a(this).attr("value"),c=a(this).attr("name");a(".ui-address .city").html(a(this).text()),a(this).addClass("selected").siblings().removeClass("selected"),a(".city-list .font-item").hide(),a(this).find(".font-item").show(),d.getCountyList(b),d.listenSaveBtnStatu(),d.para.cityId=b,d.para.cityName=c}),a(".ui-address .county-list").delegate(".county-name","click",function(){var b=a(this).attr("value"),c=a(this).attr("name");a(".ui-address  .county").html(a(this).text()),a(this).addClass("selected").siblings().removeClass("selected"),a(".county-list .font-item").hide(),a(this).find(".font-item").show(),d.getAreaList(b),d.listenSaveBtnStatu(),d.para.countryId=b,d.para.countryName=c}),a(".ui-address .area-list").delegate(".area-name","click",function(){var b=a(this).attr("value"),c=a(this).attr("name");a(".ui-address  .area").html(a(this).text()),a(this).addClass("selected").siblings().removeClass("selected"),d.listenSaveBtnStatu(),d.para.townId=b,d.para.townName=c,a(".ui-area-value").text(d.para.provinceName+d.para.cityName+d.para.countryName+d.para.townName),a(".ui-address").addClass("hide"),a(".ui-area-value").removeClass("ui-area-value-grey")}),a(".bid-selected").unbind("click").on("click",function(a){return a&&a.preventDefault?a.preventDefault():window.event.returnValue=!1,!1}),a(".ui-address .close, .ui-address").unbind("click").on("click",function(){a(".ui-address").addClass("hide")})},listenInputChange:function(){a("#username").bind("input propertychange",function(){var b=a(this).val();d.para.name=d.encrypt(b,d.para.rsaPublicKey),d.listenSaveBtnStatu(),d.setCompareSameInfo()&&(d.para.tempDefault=!1)}),a("#tel").bind("input propertychange",function(){var b=a(this).val();d.para.mobile=d.encrypt(b,d.para.rsaPublicKey),d.listenSaveBtnStatu(),d.setCompareSameInfo()&&(d.para.tempDefault=!1)}),a(".address-value").bind("input propertychange",function(){a(this).val();d.para.addressDetail=a(this).val(),a(".address-value").val().length>=50?b.lightToast("详细地址最多支持50个字"):d.listenSaveBtnStatu(),d.setCompareSameInfo()&&(d.para.tempDefault=!1)})},listenSaveBtnStatu:function(){return a("#tel").val().length>0&&a("#username").val().length>0&&a(".address-value").val().length>0&&a(".ui-area-value").text().length>0?(a(".ui-layer-ft p").css("background","#FF3434"),a(".ui-layer-ft p").addClass("shadow2"),d.saveBtnClick(),void 0):(a(".ui-layer-ft p").css("background","#d4d4d4"),a(".ui-layer-ft p").removeClass("shadow2"),!1)},saveBtnClick:function(){a(".ui-layer-ft").unbind("click").on("click",function(){d.checkPhone()?d.getAddAddress():b.lightToast("您的手机号码未输入或输入错误!")})},setCompareSameInfo:function(){return a("#tel").val().trim()!=a("#tel").attr("usertel")||a("#username").val().trim()!=a("#username").attr("username")||a(".ui-area-value").text().trim()!=a(".ui-area-value").attr("areaname")||a(".address-value").val().trim()!=a(".address-value").attr("useraddress")?!0:!1},checkPhone:function(){var b=a("#tel").val();return/^1(3|4|5|7|8)\d{9}$/.test(b)?!0:!1},getRsaPublicKey:function(){var a={url:b.getHost()+"/security/rsaPublicKey",data:{}};b.load(a).then(function(a){a&&0==a.code?d.para.rsaPublicKey=a.data:b.isNotEmpty(a.tip)?b.lightToast(a.tip):b.lightToast("加密key异常")},function(a){})},encrypt:function(a,b){var c=new JSEncrypt;c.setPublicKey(b);var d=c.encrypt(a);return d||(d=a),d},arrSplitRsa:function(a){for(var b="",c=a.length,e=Math.ceil(c/35),f=0;e>f;f++){var g=a.slice(35*f,35*(f+1));b+=d.encrypt(g,d.para.rsaPublicKey)+"-_-"}return b=b.slice(0,b.length-3)},getAddAddress:function(){var c=d.arrSplitRsa(d.para.addressDetail),e=d.arrSplitRsa(d.para.provinceName+d.para.cityName+d.para.countryName+d.para.townName+d.para.addressDetail),f={url:b.getHost()+"/receiveAddr/secAddReceiveAddr",data:{provinceId:d.para.provinceId,phone:d.para.mobile,cityId:d.para.cityId,townName:d.para.townName,cityName:d.para.cityName,provinceName:d.para.provinceName,addressDetail:c,countyName:d.para.countryName,name:d.para.name,countyId:d.para.countryId,addressName:"",fullAddress:e,postCode:"",townId:d.para.townId,addressType:1,addressDefault:d.para.addressDefault,mobile:d.para.mobile},type:"POST"};b.load(f).then(function(c){if("0"==c.code){b.lightToast("地址添加成功!"),d.para.addressDefault&&(d.para.tempDefault=!1),a("#tel").attr("usertel",a("#tel").val()),a("#username").attr("username",a("#username").val()),a(".ui-area-value").attr("areaname",a(".ui-area-value").text()),a(".address-value").attr("useraddress",a(".address-value").val());var e=b.getParameter("backUrl"),f=b.getParameter("mgUrl");b.isNotEmpty(f)?b.isNotEmpty(e)?location.replace(f+"?index="+d.para.index+"&backUrl="+encodeURIComponent(e)):location.replace(f+"?index="+d.para.index):b.lightToast("参数异常!")}else b.isNotEmpty(c.tip)?b.lightToast(c.tip):b.lightToast("地址添加失败!")},function(a){b.lightToast("地址添加失败!")})},getProvinceList:function(){var e={url:b.getHost()+"/area/getProvinceList",data:{isHidden:1}};b.load(e).then(function(b){if(b.data&&b.data.length>0){var e,f;e=a(".province-list"),f="province-name";var g=a("#address").html().replace("typename",f),h=c.template(g),i=h(b.data);e.html(i),d.addressViewHandler(1),a(".ui-address .province").show().html("请选择").addClass("selected").siblings().removeClass("selected"),a(".new .title div").each(function(b){b>1&&a(this).hide()}),a(".list").each(function(b){b>1&&a(this).find("div").removeClass("selected")})}else a(".ui-address").addClass("hide")})},getCityList:function(e){var f={url:b.getHost()+"/area/getCityListByProvinceId",data:{provinceId:e}};b.load(f).then(function(b){if(b.data&&b.data.length>0){var e,f;e=a(".city-list"),f="city-name";var g=a("#address").html().replace("typename",f),h=c.template(g),i=h(b.data);e.html(i),d.addressViewHandler(2),a(".ui-address .city").show().html("请选择").addClass("selected").siblings().removeClass("selected"),a(".new .title div").each(function(b){b>2&&a(this).hide()}),a(".list").each(function(b){b>2&&a(this).find("div").removeClass("selected")})}else a(".ui-area-value").text(d.para.provinceName),d.para.cityId=0,d.para.countryId=0,d.para.townId=0,d.para.cityName="",d.para.countryName="",d.para.townName="",a(".ui-address").addClass("hide")},function(a){b.log(a)})},getCountyList:function(e){var f={url:b.getHost()+"/area/getCountyListByCityId",data:{cityId:e}};b.load(f).then(function(b){if(b.data&&b.data.length>0){var e,f;e=a(".county-list"),f="county-name";var g=a("#address").html().replace("typename",f),h=c.template(g),i=h(b.data);e.html(i),d.addressViewHandler(3),a(".ui-address .county").show().html("请选择").addClass("selected").siblings().removeClass("selected"),a(".new .title div").each(function(b){b>3&&a(this).hide()}),a(".list").each(function(b){b>3&&a(this).find("div").removeClass("selected")})}else a(".ui-area-value").text(d.para.provinceName+d.para.cityName),d.para.countryId=0,d.para.townId=0,d.para.countryName="",d.para.townName="",a(".ui-address").addClass("hide")})},getAreaList:function(e){var f={url:b.getHost()+"/area/getTownListByCountyId",data:{countyId:e}};b.load(f).then(function(e){if(e.data&&e.data.length>0){var f,g;f=a(".area-list"),g="area-name";var h=a("#address").html().replace("typename",g),i=c.template(h),j=i(e.data);f.html(j),d.addressViewHandler(4),b.isNotEmpty(d.para.townId)?(a(".ui-address .area-name[value="+d.para.townId+"]").find(".font-item").show(),a(".ui-address .area-name[value="+d.para.townId+"]").addClass("selected").siblings().removeClass("selected"),d.para.townName=a(".ui-address .area-name[value="+d.para.townId+"]").text().trim(),a(".ui-address .province").show().html(a(".ui-address .province-name[value="+d.para.townId+"]").text()).addClass("selected").siblings().removeClass("selected")):(a(".ui-address .area-name").find(".font-item").hide(),a(".ui-address .area").show().html("请选择").addClass("selected").siblings().removeClass("selected")),a(".new .title div").each(function(b){b>4&&a(this).hide()}),a(".list").each(function(b){b>4&&a(this).find("div").removeClass("selected")})}else a(".ui-area-value").text(d.para.provinceName+d.para.cityName+d.para.countryName),d.para.townId=0,d.para.townName="",a(".ui-address").addClass("hide"),a(".ui-area-value").removeClass("ui-area-value-grey")})},addressViewHandler:function(b){var c=a(".ui-address .province-list"),d=a(".ui-address .city-list"),e=a(".ui-address .county-list"),f=a(".ui-address .area-list");switch(b){case 1:c.removeClass("hide"),d.addClass("hide"),e.addClass("hide"),f.addClass("hide");break;case 2:c.addClass("hide"),d.removeClass("hide"),e.addClass("hide"),f.addClass("hide");break;case 3:c.addClass("hide"),d.addClass("hide"),e.removeClass("hide"),f.addClass("hide");break;case 4:c.addClass("hide"),d.addClass("hide"),e.addClass("hide"),f.removeClass("hide");break;default:c.addClass("hide"),d.addClass("hide"),e.addClass("hide"),a(".ui-address").removeClass("hide")}},addressInit:function(){b.isNotEmpty(a(".ui-area-value").text())?(a(".ui-address .title div").html("请选择"),a(".ui-address .title div").addClass("selected").show().siblings().removeClass("selected").hide(),a(".ui-address .province").hide(),a(".ui-address .list").removeClass("selected"),d.getProvinceList(),a(".ui-address").removeClass("hide"),d.addressViewHandler(1)):a(".ui-address").removeClass("hide")}};d.init()});