require(["jquery","jweixin","utils","dot"],function(a,b,c,d){var e={init:function(){e.getAesKey(function(){e.initPara(function(){e.getDealDetail(),e.addClick()})})},addClick:function(){a(".btn-span1").unbind("click").bind("click",function(){e.deliverPreCheck(e.para.dealId,function(){e.userWalletBriefInfo()})}),a(".ui-btn-line").unbind("click").bind("click",function(){c.goUrl("/deliverTel.html")}),a(".reverse-dialog-dialogWallet #cancel").unbind("click").bind("click",function(){a(".reverse-dialog-dialogWallet").hide()}),a(".reverse-dialog-dialogWallet #success").unbind("click").bind("click",function(){a(".reverse-dialog-dialogWallet").hide();var b=location.href;c.goUrl("/bindWallet.html?backUrl="+encodeURIComponent(b))}),a(".reverse-dialog-dialogOpenApp #cancel").unbind("click").bind("click",function(){a(".reverse-dialog-dialogOpenApp").hide()}),a(".reverse-dialog-dialogOpenApp #success").unbind("click").bind("click",function(){a(".reverse-dialog-dialogOpenApp").hide(),"miniprogram"===window.__wxjs_environment?(console.log("小程序内打开"),b.miniProgram.redirectTo({url:"/pages/download/index"})):c.goUrl("/payWelcome.html?dealId="+e.para.dealId)}),a(".reverse-dialog-dialogWalletInfo #success").unbind("click").bind("click",function(){var a="https://m.jdpay.com/wallet/public/service/checkOuterService.htm?toUrl=http://paipai.m.jd.com/c2c/deliverGoods.html";window.location.href="https://plogin.m.jd.com/user/login.action?appid=207&returnurl="+encodeURIComponent(a)}),a(".reverse-dialog-dialogWalletInfo #cancel").unbind("click").bind("click",function(){var a=c.getParameter("backUrl");c.isNotEmpty(a)?c.goUrl("/m/express?dealId="+e.para.dealId+"&refresh=no&backUrl="+encodeURIComponent(a)):c.goUrl("/m/express?dealId="+e.para.dealId+"&refresh=no")})},para:{aesKey:"",dealId:""},initPara:function(a){var b=c.getParameter("dealId");c.isNotEmpty(b)?e.para.dealId=b:(c.log("订单参数不能为null"),e.para.dealId="10121"),a()},getAesKey:function(a){var b={url:c.getHost()+"/security/aesKey",data:{}};c.load(b).then(function(b){b&&0==b.code?e.para.aesKey=b.data:c.isNotEmpty(b.tip)?c.lightToast(b.tip):c.lightToast("解密key异常"),a()},function(b){a()})},decrypt:function(a,b){var c=CryptoJS.enc.Utf8.parse(b),d=CryptoJS.AES.decrypt(a,c,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7});return CryptoJS.enc.Utf8.stringify(d).toString()},getDealDetail:function(){var a={url:c.getHost(1)+"/order/v1/deal/secGetDealDetail",data:{dealId:e.para.dealId}};c.load(a).then(function(a){a&&0==a.code?(c.log("订单详情信息"+JSON.stringify(a)),e.renderProductInfo(a.data),e.renderAddrInfo(a.data)):c.isNotEmpty(a.tip)?c.lightToast(a.tip):c.lightToast("订单详情数据异常")},function(a){c.lightToast("网络异常，稍后重试")})},renderProductInfo:function(b){a(".ui-order-product").html(d.template(a(".product-info").text())(b))},renderAddrInfo:function(b){var c=b.receiveMobile,f=b.receiveName,g=b.receiveAddr;c.indexOf("****")>-1||/^1(3|4|5|7|8)\d{9}$/.test(c)||(b.receiveMobile=e.decrypt(c,e.para.aesKey)||""),b.receiveName=e.decrypt(f,e.para.aesKey)||f,b.receiveAddr=e.decrypt(g,e.para.aesKey)||g,a(".ui-order-address1").html(d.template(a("#addrInfo").text())(b)).removeClass("ui-hide")},queryCustomIdByJdPin:function(){var b={url:c.getHost()+"/jdWallet/queryCustomIdByJdPin"};c.load(b).then(function(b){if(b&&0==b.code)if(b.data&&c.isNotEmpty(b.data)&&b.data.length>0){var d=c.getParameter("backUrl");c.isNotEmpty(d)?c.goUrl("/m/express?dealId="+e.para.dealId+"&refresh=no&backUrl="+encodeURIComponent(d)):c.goUrl("/m/express?dealId="+e.para.dealId+"&refresh=no")}else a(".reverse-dialog-dialogWallet").show();else a(".reverse-dialog-dialogWallet").show()},function(a){c.lightToast("网络异常，稍后重试")})},userWalletBriefInfo:function(){var b={url:c.getHost()+"/jdWallet/user_wallet_brief_info"};c.load(b).then(function(b){if(b&&0==b.code&&b.data){var d=b.data;if(d.bindWallet)if(d.sameRealNameFlag){var f=c.getParameter("backUrl");c.isNotEmpty(f)?c.goUrl("/m/express?dealId="+e.para.dealId+"&refresh=no&backUrl="+encodeURIComponent(f)):c.goUrl("/m/express?dealId="+e.para.dealId+"&refresh=no")}else a(".reverse-dialog-dialogWalletInfo").show();else a(".reverse-dialog-dialogWallet").show()}},function(a){c.lightToast("网络异常，稍后重试")})},deliverPreCheck:function(b,d){var f={url:c.getHost(1)+"/order/v1/deal/deliverPreCheck",data:{dealId:b}};c.load(f).then(function(b){if(console.log(JSON.stringify(b)),c.log("去发货校验"+JSON.stringify(b)),b&&0==b.code)if(b.data.canDeliver)d();else if(20001==b.data.rejectCode||20002==b.data.rejectCode)if(20001==b.data.rejectCode)"miniprogram"===window.__wxjs_environment?a(".reverse-dialog-dialogOpenApp").show():d();else if("miniprogram"!==window.__wxjs_environment){var f=!1;1==c.getType()?f=c.getAppVersion("1.2.5"):2==c.getType()&&(f=c.getAppVersion("1.2.6")),f?c.goUrl("/payWelcome.html?dealId="+e.para.dealId):d()}else d();else d();else c.isNotEmpty(b.tip)?c.lightToast(b.tip):c.lightToast("发货校验异常")},function(a){console.log("网咯异常"),d()})}};e.init()});