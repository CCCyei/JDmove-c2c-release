require(["jquery","utils","dot"],function(a,b,c){"use strict";var d={obj:{dealId:0,tradeRefundId:"",tradeId:"",machineKey:"test",optSource:3},localObj:{btns:{alter:"修改申请",cancel:"撤销申请",arbitrament:"申请仲裁",agree:"同意退款",refuse:"拒绝申请",lookRefund:"查看退款",cancelArbitrament:"取消仲裁",evidence:"举证",urge:"催一下",address:"填写收货地址",delivery:"填写物流单",lookDelivery:"查看物流单",confirmDelivery:"确认收货"},pageclick:{alter:"pageclick|keycount|shopRefund__201708107|4",cancel:"pageclick|keycount|shopRefund__201708107|5",arbitrament:"pageclick|keycount|shopRefund__201708107|3",agree:"pageclick|keycount|shopRefund__201708107|1",refuse:"pageclick|keycount|shopRefund__201708107|2",cancelArbitrament:"pageclick|keycount|shopRefund__201708107|8",evidence:"pageclick|keycount|shopRefund__201708107|9",delivery:"pageclick|keycount|shopRefund__201708107|6",lookDelivery:"pageclick|keycount|shopRefund__201708107|11",confirmDelivery:"pageclick|keycount|shopRefund__201708107|7"},arbitramentId:"",evidenceUserFlag:"",refundType:"",deliveryCompanyId:"",deliveryCode:"",userFlag:{1:"买家",2:"卖家"}},para:{aesKey:""},init:function(){d.getAesKey(function(){var a=b.getUrlParam("dealId");return a?(d.obj.dealId=a,void d.initData()):void b.lightToast("缺少参数")})},getAesKey:function(a){var c={url:b.getHost()+"/security/aesKey",data:{}};b.load(c).then(function(c){c&&0==c.code?d.para.aesKey=c.data:b.isNotEmpty(c.tip)?b.lightToast(c.tip):b.lightToast("解密key异常"),a()},function(b){a()})},decrypt:function(a,b){var c=CryptoJS.enc.Utf8.parse(b),d=CryptoJS.AES.decrypt(a,c,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7});return CryptoJS.enc.Utf8.stringify(d).toString()},initCardList:function(b){var e=c.template(a("#cardList").text());b.forEach(function(a){a.pic&&a.pic.length&&(a.width=2.42*a.pic.length+"rem"),a.dealId=d.obj.dealId}),b.length>1&&b[1].style&&"red"==b[1].style&&b.forEach(function(a){a.time&&a.time==b[1].time&&(a.color="red")}),a(".reverse-prompt-container").html(e({array:b}));var f=a(".reverse-prompt").attr("color");f&&"red"==f&&a('.reverse-prompt[color = "red"]').addClass("selecter");var g=a('.reverse-prompt-panel-body span[type = "手机"] i').text(),h=a('.reverse-prompt-panel-body span[type = "姓名"] i').text(),i=a('.reverse-prompt-panel-body span[type = "地址"] i').text(),j=d.para.aesKey;g.indexOf("****")>-1||/^1(3|4|5|7|8)\d{9}$/.test(g)||a('.reverse-prompt-panel-body span[type = "手机"]').text(d.decrypt(g,j)),a('.reverse-prompt-panel-body span[type = "姓名"]').text(d.decrypt(h,j)||h),a('.reverse-prompt-panel-body span[type = "地址"]').text(d.decrypt(i,j)||i)},initData:function(){var c={url:b.getHost(1)+"/order/v1/refund/secGetDealRefundDetail",data:{dealId:d.obj.dealId,cardFlag:1}};b.load(c).then(function(c){if(0==c.code){var e=c.data;if(1==e.dealType&&b.isNotEmpty(e.pcoin)?(a(".ui-warning").removeClass("ui-hide"),a(".reverse-prompt-container").css({"margin-top":"1.28rem"})):(a(".ui-warning").addClass("ui-hide"),a(".reverse-prompt-container").css({"margin-top":"0"})),e.refundMessage&&(e.refundMessage=e.refundMessage.replace(/{pcoinImg}/g,"  <img src='image/paibiBig.png' class='paibi-img' />"),e.cardList.push({sign:!0,time:e.cardList.length?e.cardList[e.cardList.length-1].time:b.formatDate((new Date).getTime()),title:e.refundMessage.split("<br>")[0],list:[{content:e.refundMessage.replace(e.refundMessage.split("<br>")[0]+"<br>","").replace(/{refundToBuyer}/g,"¥"+e.refundToBuyer).replace(/{refundTimeout}/g,'<i class="reverse-over-time">'+b.restTimeCountDownc2c(e.refundTimeoutRemainTime)+"</i>")}]})),e.refundTimeoutRemainTime&&e.refundTimeoutRemainTime>0)var f=e.refundTimeoutRemainTime,g=setInterval(function(){f-=1,a(".reverse-over-time").text(b.restTimeCountDownc2c(f)),0>=f&&(clearInterval(g),location.reload())},1e3);d.obj.tradeRefundId=e.tradeRefundId,d.obj.tradeId=e.tradeId,d.localObj.refundState=e.refundState,d.localObj.arbitramentId=e.arbitramentId,d.localObj.evidenceUserFlag=e.userFlag,d.localObj.refundType=e.refundType,d.localObj.deliveryCompanyId=e.deliveryCompanyId,d.localObj.deliveryCode=e.deliveryCode,d.localObj.refundCount=e.refundCount||0;for(var h=[],i=d.localObj.btns,j=d.localObj.pageclick,k=e.operButtonsList||[],l=0;l<k.length;l++){var m=k[l];h.push({id:m,name:i[m],pageclick:j[m]||""})}b.footerInit(h,0),e.cardList=e.cardList.reverse(),e.cardList&&e.cardList.length>0&&e.cardList.forEach(function(a){b.isNotEmpty(a.list)&&a.list.length>0&&a.list.forEach(function(a,b){a.content=a.content.replace(/{pcoinImg}/g,"  <img src='image/paibiBig.png' class='paibi-img' />")})}),d.initCardList(e.cardList),d.bindEvents()}else b.isNotEmpty(c.tip)?b.lightToast(c.tip):b.lightToast("信息异常~")},function(a){b.lightToast("网络出错，请稍后再试！")})},bindEvents:function(){a(".reverse-dialog").delegate(".reverse-dialog-panel-btns > div","click",function(){var c=a(this).attr("data-key");if("agree"==c){var e="";e=1==d.localObj.refundType?b.getHost(1)+"/order/v1/refund/agreeRefund":b.getHost(1)+"/order/v1/refund/agreeRefund4Delivery";var f={url:e,data:d.obj};b.load(f).then(function(a){0==a.code?location.reload():b.isNotEmpty(a.tip)&&b.lightToast(a.tip)},function(a){b.lightToast("网络出错，请稍后再试！")})}else if("cancel"==c){var f={url:b.getHost(1)+"/order/v1/refund/cancelRefund",data:d.obj};b.load(f).then(function(a){"0"===a.code?b.goUrl("/orderDetail.html?dealId="+d.obj.dealId):b.isNotEmpty(a.tip)&&b.lightToast(a.tip)},function(a){b.lightToast("网络出错，请稍后再试！")})}else if("cancelArbitrament"==c){var f={url:b.getHost(1)+"/order/v1/arbitrament/cancelArbitrament",data:{arbitramentId:d.localObj.arbitramentId}};b.load(f).then(function(a){0==a.code?location.reload():b.isNotEmpty(a.tip)&&b.lightToast(a.tip)},function(a){b.lightToast("网络出错，请稍后再试！")})}else if("confirmDelivery"==c){var f=("?dealId="+d.obj.dealId,{url:b.getHost(1)+"/order/v1/refund/confirmReceived",data:d.obj});b.load(f).then(function(a){0==a.code?location.reload():b.isNotEmpty(a.tip)&&b.lightToast(a.tip)},function(a){b.lightToast("网络出错，请稍后再试！")})}a(".reverse-dialog").hide()}),a(".reverse-footer").delegate("div","click",function(){var c=a(this).attr("id");if("alter"===c){var e="?dealId="+d.obj.dealId;b.goUrl("/applyRefund.html"+e)}else if("cancel"===c)a(".reverse-dialog-panel .reverse-dialog-panel-info").text("确认撤销申请？"),a(".reverse-dialog-panel-btns #success").attr("data-key","cancel"),a(".reverse-dialog").show();else if("arbitrament"===c){if(d.localObj.refundCount<2&&32!=d.localObj.refundState)return void b.lightToast("卖家拒绝退款2次后可以申请仲裁");var e="?dealId="+d.obj.dealId;b.goUrl("/applyAward.html"+e)}else if("agree"===c)a(".reverse-dialog-panel .reverse-dialog-panel-info").text("确认同意？"),a(".reverse-dialog-panel-btns #success").attr("data-key","agree"),a(".reverse-dialog").show();else if("refuse"===c){var e="?dealId="+d.obj.dealId;b.goUrl("/refuseRefund.html"+e)}else if("evidence"===c){var e="?dealId="+d.obj.dealId+"&arbitramentId="+d.localObj.arbitramentId+"&evidenceUserFlag="+d.localObj.evidenceUserFlag;b.goUrl("/proof.html"+e)}else if("cancelArbitrament"===c)a(".reverse-dialog-panel .reverse-dialog-panel-info").text("确认撤销仲裁？"),a(".reverse-dialog-panel-btns #success").attr("data-key","cancelArbitrament"),a(".reverse-dialog").show();else if("urge"===c){var e="?dealId="+d.obj.dealId,f={url:b.getHost(1)+"/order/v1/deal/reminderDeal",data:{dealId:d.obj.dealId}};b.load(f).then(function(a){0==a.code?(b.lightToast(a.tip||"请稍后再试"),location.reload()):b.isNotEmpty(a.tip)&&b.lightToast(a.tip)},function(a){b.lightToast("网络出错，请稍后再试！")})}else if("address"===c){var e="?dealId="+d.obj.dealId;b.goUrl("/buyerPost.html"+e)}else if("delivery"===c){var g="/c2c/refundDetail.html?dealId="+d.obj.dealId,e="&dealId="+d.obj.dealId+"&userFlag=1&backUrl="+encodeURIComponent(g);b.goUrl("/m/express?refresh=no"+e)}else if("lookDelivery"===c){var e="?wayBillCode="+d.localObj.deliveryCode+"&logisticsCode="+d.localObj.deliveryCompanyId+"&dealId="+d.obj.dealId;b.goUrl("/orderTrack.html"+e)}else"confirmDelivery"===c&&(a(".reverse-dialog-panel .reverse-dialog-panel-info").text("确认收货？"),a(".reverse-dialog-panel-btns #success").attr("data-key","confirmDelivery"),a(".reverse-dialog").show())}),a(".reverse-prompt-container").delegate(".reverse-prompt-imgs-list img","click",function(){for(var c=a(this).parents(".reverse-prompt-imgs-list").children(),d=a(this).attr("data-index"),e=[],f=a(this).parents(".reverse-prompt-imgs-list").children().length,g=0;f>g;g++)e.push(c.eq(g).attr("data-src"));var h={pics:e,index:d};if("ershou"==b.getAppType()){var i="openapp.paipai://showBigPic/app?param="+encodeURIComponent(JSON.stringify(h));location.href=i}}),a(".img-close").click(function(){a(".ui-warning").addClass("ui-hide"),a(".reverse-prompt-container").css({"margin-top":"0"})})}};d.init()});