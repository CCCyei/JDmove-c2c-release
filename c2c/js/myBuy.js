function setCommonParams(a){commonPara=a}!function(){function a(a){document.body.scrollTop=document.documentElement.scrollTop=a}function b(){return document.body.scrollTop||document.documentElement.scrollTop}var c=0;open.onclick=function(){c=b(),document.body.classList.add("dialog-open"),document.body.style.top=-c+"px",mask.style.display="block"},close.onclick=function(){mask.style.display="none",document.body.classList.remove("dialog-open"),a(c)}}();var commonPara;require(["jquery","utils","dot","paipaiSDK"],function(a,b,c,d){"use strict";var e={dealId:"",currentPage:"",pageCount:"",jdOrderCode:"",key:""},f={id:"select-reason",arr:[{name:"与卖家协商一致",value:1},{name:"卖家未发货",value:2},{name:"信息填写错误重新拍",value:3},{name:"卖家商品无货",value:4},{name:"拍错/误点",value:5},{name:"不想要了",value:6},{name:"其他",value:7}]};b.selectFloat(f,function(b){var c=a(b).html(),d=a(b).attr("data-value");g.cancelDeal(c,e.dealId,d)});var g={page:1,pageSize:20,isLoading:!1,isAllLoad:!1,init:function(){g.getBuyList(g.page,g.pageSize),g.addScorll(),3!=b.getType()&&g.initPayPar()},initPayPar:function(){2==b.getType()?window.webkit.messageHandlers.AppWindControlModel.postMessage(1):location.href="openapp.paipai://fengkong/app"},bodyScollHandler:function(){a(".reverse-dialog").is(":visible")?a("body").addClass("dialog-open"):a("body").removeClass("dialog-open")},addScorll:function(){a(window).on("scroll",function(){var b=a(window).scrollTop(),c=a(window).height(),d=document.body.scrollHeight;!g.isLoading&&!g.isAllLoad&&b+c+300>d&&(g.page+=1,g.isLoading=!0,g.getBuyList(g.page,g.pageSize))})},getBuyList:function(c,d){var f={url:b.getHost(1)+"/order/v1/deal/getBuyingHistoryList",data:{index:c,size:d}};b.load(f).then(function(c){b.log(c),"0"==c.code?c.data.result&&c.data.result.length>0?(e.currentPage=c.data.currentPage,e.pageCount=c.data.pageCount,g.renderBuyListInfo(c.data.result),"wx"==b.getLoginCodeType()?(a(".ui-warning").show(),a(".ui-top>div").hide(),a(".ui-adress-edit").hide(),a(".goods").css("border-bottom","none")):a(".wx-first").css({"margin-top":"0.26652452rem"}),g.isLoading=!1,(!c.data.result||c.data.result.length<g.pageSize)&&(g.isAllLoad=!0)):1==g.page?(a(".buy-button").show(),a(".bgview").removeClass("hide"),a(".bgview p").text("您还未购买过商品~"),a(".bgview img").attr("src","image/noBuy.png")):b.lightToast("没有更多了"):b.isNotEmpty(c.tip)?b.lightToast(c.tip):b.lightToast("获取我购买列表异常")},function(a){})},renderBuyListInfo:function(d){d=d||[],a("body").append(c.template(a(".renderBuyListInfo").text())(d)),a(".goods").click(function(){var c=a(this).attr("dealId");b.goUrl("/orderDetail.html?dealId="+c+"&refresh=no")}),e.key=a(".ui-edit").attr("key"),"cancel"==e.key&&a(".ui-edit").attr("clstag","pageclick|keycount|myBuy__2017081019|1"),3==b.getType()&&(a('.ui-edit[key="lookRefund"]').remove(),a('.ui-edit[key="comment"]').remove(),a('.ui-edit[key="lookComment"]').remove(),a('.ui-edit[key="refund"]').remove()),a(".ui-edit").unbind("click").bind("click",function(){e.dealId=a(this).parents(".ui-adress-edit").attr("dealId"),e.jdOrderCode=a(this).parents(".ui-adress-edit").attr("jdOrderCode"),e.key=a(this).attr("key"),"查看发票"==a(this).text()&&g.getResellList(),"cancel"==e.key?(a(this).attr("clstag","pageclick|keycount|myBuy__2017081019|1"),a(".reverse-select").show()):"urge"==e.key?g.reminderDeal():"confirmDelivery"==e.key?(a(".reverse-dialog").show(),g.bodyScollHandler(),a("#success").unbind("click").bind("click",function(){g.confirmReceived(),g.bodyScollHandler()}),a("#cancel").click(function(){a(".reverse-dialog").hide(),g.bodyScollHandler()})):"pay"==e.key?g.getPayInfo(e.dealId):"lookComment"==e.key?b.goUrl("/evaDetail.html?orderId="+e.dealId):"refund"==e.key?b.goUrl("/applyRefund.html?dealId="+e.dealId):"lookRefund"==e.key?b.goUrl("/refundDetail.html?dealId="+e.dealId):"comment"==e.key?b.goUrl("/assessEdit.html?orderId="+e.dealId):"delay"==e.key&&"延长收货"===a(this).text()?(a(".reverse-dialog-dely").show(),g.bodyScollHandler(),a("#delySuccess").unbind("click").bind("click",function(){a(".reverse-dialog-dely").hide(),g.extendGoods(e.dealId)}),a("#delyCancel").click(function(){a(".reverse-dialog-dely").hide(),g.bodyScollHandler()})):"delay"==e.key&&"联系客服"===a(this).text()?"ershou"!==b.getAppType()?tools.goUrl("//dd1-m.jd.com/chat/index.action?venderId=1&appId=jd.waiter&customerAppId=im.customer&entry=jd_m_paipai"):window.location.href="openapp.paipai://chatWithTimLineInHelpCenter/app?param="+encodeURIComponent('{"key0":1}'):"help"==e.key&&("ershou"!==b.getAppType()?tools.goUrl("//dd1-m.jd.com/chat/index.action?venderId=1&appId=jd.waiter&customerAppId=im.customer&entry=jd_m_paipai"):window.location.href="openapp.paipai://chatWithTimLineInHelpCenter/app?param="+encodeURIComponent('{"key0":1}'))}),a(".ui-concat").unbind("click").bind("click",function(){e.dealId=a(this).parents(".ui-adress-edit").attr("dealId");var c=a(this).attr("sku"),d=a(this).attr("uin");b.log("sku"+c),b.log("uin"+d);var f=a(this).html();if("联系卖家"==f)if(3==b.getType())b.goUrl("/chat/im?otherUin="+d+"&pid="+c);else{var g={sku:c,uin:d},h="openapp.paipai://im/app?param="+encodeURIComponent(JSON.stringify(g));location.href=h}})},getResellList:function(){var a={url:b.getHost()+"/invoice/query",data:{orderId:e.jdOrderCode||""}};b.load(a).then(function(a){b.log("获取发票"+JSON.stringify(a)),console.log(a),"0"===a.code?(console.log(a.data[0]),location.href=a.data[0]):b.isNotEmpty(a.tip)?b.lightToast(a.tip):b.lightToast("获取发票异常")},function(a){})},cancelDeal:function(a,c,d){var e={url:b.getHost(1)+"/order/v1/deal/cancelDeal",data:{dealId:c,closeReasonDesc:a,closeReason:d,optSource:"3",machineKey:"test"}};b.load(e).then(function(a){b.log("取消订单"+JSON.stringify(a)),a&&0==a.code?location.reload():b.isNotEmpty(a.tip)?b.lightToast(a.tip):b.lightToast("取消订单异常")},function(a){})},reminderDeal:function(){var a={url:b.getHost(1)+"/order/v1/deal/reminderDeal",data:{dealId:e.dealId}};b.load(a).then(function(a){b.log("催一下"+JSON.stringify(a)),a&&0==a.code?b.lightToast("已催促卖家发货，请耐心等待"):b.isNotEmpty(a.tip)?b.lightToast(a.tip):b.lightToast("催一下异常")},function(a){})},confirmReceived:function(){var c={url:b.getHost(1)+"/order/v1/deal/confirmReceived",data:{dealId:e.dealId,optSource:"3",machineKey:"test"}};b.load(c).then(function(c){b.log("确认收货"+JSON.stringify(c)),c&&0==c.code?(location.reload(),a(".reverse-dialog").hide()):b.isNotEmpty(c.tip)?(b.lightToast(c.tip),a(".reverse-dialog").hide()):(b.lightToast("确认收货异常"),a(".reverse-dialog").hide())},function(a){})},getPayInfo:function(c){var d={url:b.getHost(1)+"/order/v1/deal/getPayDataByDealId",data:{dealId:c}},e={};b.isNotEmpty(commonPara)&&(e=a.extend(e,d.data,commonPara),d.data=e),b.load(d).then(function(a){b.log("收银台参数"+JSON.stringify(a)),a&&0==a.code?g.jumpJDPay(a.data,a.payUrl):b.isNotEmpty(a.tip)?b.lightToast(a.tip):b.lightToast("收银台参数异常")},function(a){})},jumpJDPay:function(c,d){b.isEmpty(d)&&(d="//test.h5pay.jd.com/jdpay/saveOrder");var e=a('<form method="post" action="'+d+'"></form>');Object.keys(c).forEach(function(a){b.log(a+"||"+c[a]),e.append('<input type="hidden" name="'+a+'" value="'+c[a]+'">')}),e.appendTo("body").submit()},extendGoods:function(c){var d={url:b.getHost(1)+"/order/v1/deal/updateConfirmReceivedTime",type:"POST",data:{dealId:c}};b.load(d).then(function(d){d&&0==d.code?a("#"+c).html("联系客服"):b.isNotEmpty(d.tip)?b.lightToast(d.tip):b.lightToast("延迟收货异常")},function(a){b.lightToast("网络异常，稍后重试")})}};g.init()});