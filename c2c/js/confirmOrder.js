var commonPara,commonBiz,commonDealId;window.setCommonParams=function(a){commonPara=a,commonBiz.getPayInfo()},function(){function a(a){document.body.scrollTop=document.documentElement.scrollTop=a}function b(){return document.body.scrollTop||document.documentElement.scrollTop}var c=0;open.onclick=function(){c=b(),document.body.classList.add("dialog-open"),document.body.style.top=-c+"px",mask.style.display="block"},close.onclick=function(){mask.style.display="none",document.body.classList.remove("dialog-open"),a(c)}}(),require(["jquery","jweixin","utils","dot"],function(a,b,c,d){"use strict";var e=c.getParameter("ism"),f={init:function(){var b=c.getParameter("commodityId");c.isEmpty(b)?c.log("参数错误"):f.para.commodityId=b,f.getAesKey(function(){f.getBillByCommodityId();var b=c.getParameter("addressInfo");if(c.isEmpty(b))f.getDefaultReceiveAddr();else{var d=JSON.parse(b);f.para.addr={addressId:d.addressId,addressName:d.receiveName,name:d.receiveName,mobile:d.mobile,provinceId:d.provinceId,cityId:d.cityId,areaName:"",addressDetail:d.addressName,index:d.index},f.renderAddrInfo(f.para.addr),a(".ui-order-address1").removeClass("ui-hide")}f.addClick()})},para:{addr:{},proInfo:"",commodityId:"",aesKey:""},getAesKey:function(a){var b={url:c.getHost()+"/security/aesKey",data:{}};c.load(b).then(function(b){b&&0==b.code?f.para.aesKey=b.data:c.isNotEmpty(b.tip)?c.lightToast(b.tip):c.lightToast("解密key异常"),a()},function(b){a()})},decrypt:function(a,b){var c=CryptoJS.enc.Utf8.parse(b),d=CryptoJS.AES.decrypt(a,c,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7});return CryptoJS.enc.Utf8.stringify(d).toString()},initPayPar:function(){2==c.getType()?window.webkit.messageHandlers.AppWindControlModel.postMessage(1):location.href="openapp.paipai://fengkong/app"},addClick:function(){a(".ui-bb-right span").unbind("click").bind("click",function(){c.setDoubleClick(function(){if(2==f.para.proInfo.commodityType){var a={event_id:"687",event_param:"paipai_1533810291580|22"};c.addUnify(a),f.chackPcoin()}else c.isNotEmpty(f.para.addr)?f.checkSensitive(function(){f.createDeal()}):c.lightToast("请设置您的收货地址")})}),a(".ui-order-product").unbind("click").bind("click",function(){if(2==f.para.proInfo.commoditySource){var a="/c2c/m/popGoodsDetail?commodityId="+f.para.proInfo.commodityId+"&refresh=no";c.goUrl(a)}else"yes"===e?c.goUrl("/c2c/goodsDetail.html?ism=yes&itemid="+f.para.commodityId):location.href='openapp.paipai://pushToC2CDetail/app?param={"key1":'+f.para.commodityId+"}"}),a(".ui-order-address1,.ui-order-address2").unbind("click").bind("click",function(){if(f.para.addr.index)var a="/c2c/deliveryGoods.html?backUrl="+encodeURIComponent("/c2c/confirmOrder.html?commodityId="+f.para.commodityId)+"&index="+f.para.addr.index;else if(c.isNotEmpty(f.para.addr))var a="/c2c/deliveryGoods.html?backUrl="+encodeURIComponent("/c2c/confirmOrder.html?commodityId="+f.para.commodityId)+"&index=0";else var a="/c2c/deliveryGoods.html?backUrl="+encodeURIComponent("/c2c/confirmOrder.html?commodityId="+f.para.commodityId);c.goUrl(a)}),a(".reverse-dialog-fail #success ").unbind("click").bind("click",function(){a(".reverse-dialog-fail").hide(),f.bodyScollHandler()}),a(".reverse-dialog-down #success").unbind("click").bind("click",function(){a(".reverse-dialog-down").hide();var b={event_id:"684",event_param:"paipai_1533810291580|19"};c.addUnify(b),setTimeout(function(){c.goUrl("/c2c/mine/pp-coin")},300),f.bodyScollHandler()}),a(".reverse-dialog-down #cancel").unbind("click").bind("click",function(){a(".reverse-dialog-down").hide();var b={event_id:"685",event_param:"paipai_1533810291580|20"};c.addUnify(b),f.bodyScollHandler()}),a(".reverse-dialog-paibi #success").unbind("click").bind("click",function(){a(".reverse-dialog-paibi").hide(),f.bodyScollHandler();var b={event_id:"698",event_param:"paipai_1533810291580|33"};c.addUnify(b)})},bodyScollHandler:function(){a(".reverse-dialog-fail, .reverse-dialog-paibi ,.reverse-dialog-down").is(":visible")||a(".reverse-dialog").is(":visible")?a("body").addClass("dialog-open"):a("body").removeClass("dialog-open")},setButton:function(b){b?(a(".ui-btn-bottom .ui-bb-right span").html("提交订单"),c.isNotEmpty(b.totalFee)&&(a(".ui-btn-bottom .ui-bb-left i").html("实付款"),a(".ui-btn-bottom .ui-bb-left span").html('<span class="">&yen;</span>'+b.totalFee),a(".total-price").html(b.totalFee)),a(".ui-btn-bottom").removeClass("ui-hide")):a(".ui-btn-bottom").addClass("ui-hide")},getBillByCommodityId:function(){var a={url:c.getHost(4)+"/order/v1/deal/getBillByCommodityId",data:{commodityId:f.para.commodityId}};c.load(a).then(function(a){f.renderProductInfo(a.data),a&&0==a.code?(f.para.proInfo=a.data,f.setButton(a.data)):(c.isNotEmpty(a.tip)?c.lightToast(a.tip):c.lightToast("数据异常"),f.setButton());var b=a.data;b&&(c.addMping({event_id:"paipai_1533540857048|1",event_param:"'isWarranty':"+b.isWarranty,page_name:"C2C提交订单页"}),"0"==b.commoditySource?c.addMping({event_id:"PaiPai_1527823553984|30",event_level:"",event_param:"",page_name:"C2C个人闲置确认订单页"}):"1"==b.commoditySource&&(c.addMping({event_id:"PaiPai_1527823553984|31",event_level:"",event_param:"",page_name:"C2C一键转卖确认订单页"}),"1"==b.isViewOriginalInfo&&c.addMping({event_id:"PaiPai_1527823553984|26",event_level:"",event_param:"",page_name:"展示京东订单信息商品的确认订单页"})))},function(a){c.lightToast("网络异常，稍后重试")})},getDefaultReceiveAddr:function(){var b={url:c.getHost()+"/receiveAddr/secGetDefaultReceiveAddr"};c.load(b).then(function(b){if(b&&0==b.code&&c.isNotEmpty(b.data)){c.log("默认收货地址"+JSON.stringify(b));var d=b.data;f.para.addr=d,f.para.addr.areaName=b.data.countyId,f.para.addr.addressDetail=f.para.addr.fullAddress,f.para.addr.addressId=f.para.addr.id||"",d.name=f.decrypt(d.name,f.para.aesKey)||d.name,d.fullAddress=f.decrypt(d.fullAddress,f.para.aesKey)||d.fullAddress,f.renderAddrInfo(d),a(".ui-order-address1").removeClass("ui-hide")}else a(".ui-order-address1").addClass("ui-hide"),a(".ui-order-address2").removeClass("ui-hide")},function(a){c.log("去选择地址")})},chackPcoin:function(){var b={url:c.getHost(3)+"/pcoinCommodity/dealCheck",data:{commodityId:c.getParameter("commodityId")}};c.load(b).then(function(b){console.log(b.data),b&&0==b.code?c.isNotEmpty(f.para.addr)?f.checkSensitive(function(){f.createDeal()}):c.lightToast("请设置您的收货地址"):b&&682==b.code?(a(".reverse-dialog-down .reverse-dialog-panel-info").html("您当前拥有"+b.data.userPcoin+'拍币<div class="reverse-dialog-panel-tishi">还差'+b.data.diff+"拍币才能拍下宝贝哦~</div>"),a(".reverse-dialog-down").show(),f.bodyScollHandler()):b&&683==b.code&&(a(".reverse-dialog-paibi .reverse-dialog-panel-info").html(b.tip),a(".reverse-dialog-paibi").show(),f.bodyScollHandler())},function(a){c.log("校验拍币接口失败")})},checkSensitive:function(b){var d=f.para.proInfo;1==f.para.addr.provinceId&&c.isNotEmpty(d.sensitiveFlag)&&d.sensitiveFlag&&c.isNotEmpty(d.sensitiveWords)?(a(".reverse-dialog-fail .reverse-dialog-panel-info").html("北京地区禁止进行"+d.sensitiveWords+"商品的交易"),a(".reverse-dialog-fail").show(),f.bodyScollHandler()):b()},createDeal:function(){c.addMping({event_id:"paipai_1532654274476|1",event_level:"",event_param:"",page_name:"C2C个人闲置确认订单页"});var a=f.para.proInfo,d={url:c.getHost(4)+"/order/v1/deal/createDeal",data:{commodityId:"",commodityName:"",pic:"",charactersDesc:"",sellPrice:"",originalCost:"",commodityShippingFee:"",selledCount:"",dealPayFeeShipping:"",dealPayFeeTotal:"",addressId:"",payType:"",optSource:"3",machineKey:"test"}};"miniprogram"===window.__wxjs_environment&&(c.addMping({event_id:"paipai_1532654274476|2",event_level:"",event_param:"",page_name:"C2C个人闲置确认订单页"}),d.data.mpSource="4"),d.data.commodityId=a.commodityId,d.data.commodityName=a.commodityName,d.data.charactersDesc=a.charactersDesc,d.data.pic=a.pic,d.data.originalCost=a.originalPrice,d.data.sellPrice=a.sellPrice,d.data.selledCount=a.selledCount,d.data.dealPayFeeShipping=a.shippingFee,d.data.commodityShippingFee=a.shippingFee,d.data.dealPayFeeTotal=a.totalFee,d.data.addressId=f.para.addr.addressId,d.data.payType="1",c.load(d).then(function(d){if(d&&0==d.code&&d.data)if(d.data.order.dealId){if(commonDealId=d.data.order.dealId,"miniprogram"===window.__wxjs_environment)return void b.miniProgram.redirectTo({url:"/pages/pay/pay?type=c2c&orderid="+commonDealId+"&num="+a.totalFee});3!=c.getType()?f.initPayPar():f.getPayInfo()}else c.isNotEmpty(d.tip)?c.lightToast(d.tip):c.lightToast("创建订单失败，商品已售出或下架");else c.isNotEmpty(d.tip)?c.lightToast(d.tip):c.lightToast("创建订单失败，商品已售出或下架")},function(a){c.lightToast("网络异常，稍后重试")})},renderAddrInfo:function(b){a(".ui-order-address1").html(d.template(a("#addrInfo").text())(b))},renderProductInfo:function(b){c.isNotEmpty(b)?(a(".ui-order-product").html(d.template(a(".product-info").text())(b)),c.isNotEmpty(b.shippingFee)&&a(".ui-order-freight .ui-of-right span").html('+<span class="yuan">¥</span>'+b.shippingFee)):(c.lightToast("商品信息异常"),c.log("商品信息异常"))},getPayInfo:function(){var b={url:c.getHost(4)+"/order/v1/deal/getPayDataByDealId",data:{dealId:commonDealId}},d={};c.isNotEmpty(commonPara)&&(d=a.extend(d,b.data,commonPara),b.data=d),c.load(b).then(function(a){if(a&&0==a.code){var b="./orderDetail.html?dealId="+commonDealId,d=c.getParameter("backUrl");c.isNotEmpty(d)&&(b=c.getBackUrl()),history.replaceState("",document.title,b),setTimeout(function(){f.jumpJDPay(a.data,a.payUrl)},300)}else c.isNotEmpty(a.tip)?c.lightToast(a.tip):c.lightToast("收银台数据异常")},function(a){c.lightToast("网络异常，稍后重试")})},jumpJDPay:function(b,d){c.isEmpty(d)&&(d="//test.h5pay.jd.com/jdpay/saveOrder");var e=a('<form method="post" action="'+d+'"></form>');Object.keys(b).forEach(function(a){c.log(a+"||"+b[a]),e.append('<input type="hidden" name="'+a+'" value="'+b[a]+'">')}),e.appendTo("body").submit()}};f.init(),window.onpageshow=function(a){a.persisted&&f.init()},commonBiz=f});