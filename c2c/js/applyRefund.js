require(["jquery","utils","dot","uploadShowLocalPic"],function(a,b,c){"use strict";var d={},e={},f={},g={obj:{dealId:0,refundType:"",refundGoodsType:"",refundReasonType:"",refundToBuyer:0,refundReasonDesc:"",pic:"",machineKey:"test",optSource:3},editObj:{tradeRefundId:"",tradeId:""},hasPaibi:!1,localObj:{},init:function(){var c=b.getUrlParam("dealId");if(!c)return void b.lightToast("缺少参数");g.obj.dealId=c;var d={url:b.getHost(1)+"/order/v1/refund/secGetDealRefundDetail",data:{dealId:c}};b.load(d).then(function(c){var d=c.data;if(0!=c.code)return void b.lightToast(c.tip||"网络出错，请稍后再试");if(d&&28==d.refundState){if(g.editObj.tradeRefundId=d.tradeRefundId,g.editObj.tradeId=d.tradeId,g.obj.refundType=d.refundType,g.obj.refundReasonType=d.refundReasonType,g.obj.refundGoodsType=d.refundGoodsType||"",g.obj.refundToBuyer=d.refundToBuyer,g.obj.refundReasonDesc=d.refundReasonDesc,g.localObj.dealPayFeeTotal=d.dealPayFeeTotal,g.localObj.refundState=d.refundState,g.localObj.dealState=d.dealState,g.localObj.buyerPic=d.buyerPic,1==d.dealType&&b.isNotEmpty(d.pcoin)){g.hasPaibi=!0;var e="<img src='image/paibiBig.png' class='paibi-img' />  "+d.pcoin;a("#refund-pcoin .reverse-panel-right").html(e),a("#refund-pcoin").removeClass("hide"),a(".ui-warning").removeClass("ui-hide"),a("section").eq(0).css({"margin-top":"1.28rem"})}else a(".ui-warning").addClass("ui-hide"),a("section").eq(0).css({"margin-top":"0"});g.editRefund()}else{if(d&&!d.refundState)return void g.createRefund();b.lightToast("暂不能修改申请")}},function(a){b.lightToast("网络出错，请稍后再试")}),g.addClick()},addClick:function(){a(".img-close").click(function(){a(".ui-warning").addClass("ui-hide"),a("section").eq(0).css({"margin-top":"0"})})},createRefund:function(){var c={url:b.getHost(1)+"/order/v1/deal/secGetDealDetail",data:{dealId:g.obj.dealId}};b.load(c).then(function(c){var d=c.data;if(d){if((102==d.dealState||d.dealState<=2)&&(g.obj.refundType=1),g.obj.refundToBuyer=d.dealPayFeeTotal,g.localObj.dealPayFeeTotal=d.dealPayFeeTotal,g.localObj.refundState=d.refundState,g.localObj.dealState=d.dealState,1==d.dealType&&b.isNotEmpty(d.pcoin)){g.hasPaibi=!0;var e="<img src='image/paibiBig.png' class='paibi-img' />  "+d.pcoin;a("#refund-pcoin .reverse-panel-right").html(e),a("#refund-pcoin").removeClass("hide"),a(".ui-warning").removeClass("ui-hide"),a("section").eq(0).css({"margin-top":"1.28rem"})}else a(".ui-warning").addClass("ui-hide"),a("section").eq(0).css({"margin-top":"0"});d.dealState>2&&102!=d.dealState?(g.hasShipped(),g.initBindMoneyInput()):g.notShipped(),g.initBindRemark(),g.initBindSubmit()}},function(a){b.lightToast("网络出错，请稍后再试！")})},editRefund:function(){102==g.localObj.dealState||g.localObj.dealState<=2?g.notShipped():(g.hasShipped(),g.initBindMoneyInput()),g.initBindRemark(),g.initBindSubmit()},notShipped:function(){a("#refund-type .reverse-panel-right").html("仅退款"),a("#refund-money input").css("display","none"),a("#refund-money .money-sign").css("display","inline-block").text("￥"+g.obj.refundToBuyer),g.reasonType(1),g.obj.refundReasonType&&(f.arr||[]).forEach(function(b){b.value==g.obj.refundReasonType&&a("#refund-reason .reverse-panel-right").html(b.name+'<img src="image/to-right.png" class="reverse-panel-right-arrow">')}),g.obj.refundReasonDesc&&(a(".reverse-remark-textarea").val(g.obj.refundReasonDesc),a(".reverse-remark-textarea").siblings(".reverse-remark-count").find("span").text(g.obj.refundReasonDesc.length+" "),g.obj.refundReasonDesc=g.obj.refundReasonDesc),(g.localObj.buyerPic||[]).forEach(function(b){if(b){imgObj[b]=b;var c='<div class="reverse-upload-img" data-key="'+b+'"><div class="reverse-upload-remove">x</div><img src="'+(getImageHost()+"/paipai/s160x160_")+b+'!cc_1x1" onerror="this.src = image/item-default.png\'"></div>';a(".reverse-upload-imgs #uploadImg").before(c)}})},hasShipped:function(b){if(g.refundType(),g.obj.refundType&&(d.arr||[]).forEach(function(b){b.value==g.obj.refundType&&a("#refund-type .reverse-panel-right").html(b.name+'<img src="image/to-right.png" class="reverse-panel-right-arrow">')}),1==g.obj.refundType?(a("#refund-goods").show(),g.goodsType(1)):2==g.obj.refundType&&g.reasonType(3),g.obj.refundGoodsType&&(e.arr||[]).forEach(function(b){b.value==g.obj.refundGoodsType&&a("#refund-goods .reverse-panel-right").html(b.name+'<img src="image/to-right.png" class="reverse-panel-right-arrow">')}),g.obj.refundReasonType&&(f.arr||[]).forEach(function(b){b.value==g.obj.refundReasonType&&a("#refund-reason .reverse-panel-right").html(b.name+'<img src="image/to-right.png" class="reverse-panel-right-arrow">')}),g.obj.refundToBuyer){a("#refund-money .money-sign").show(),a(".money-hide").text(g.obj.refundToBuyer);var c=a(".money-hide").width();a("#refund-money input").width(c?c+5:"115"),a("#refund-money input").val(g.obj.refundToBuyer)}g.obj.refundReasonDesc&&(a(".reverse-remark-textarea").val(g.obj.refundReasonDesc),a(".reverse-remark-textarea").siblings(".reverse-remark-count").find("span").text(g.obj.refundReasonDesc.length+" "),g.obj.refundReasonDesc=g.obj.refundReasonDesc),(g.localObj.buyerPic||[]).forEach(function(b){if(b){imgObj[b]=b;var c='<div class="reverse-upload-img" data-key="'+b+'"><div class="reverse-upload-remove">x</div><img src="'+(getImageHost()+"/paipai/s160x160_")+b+'!cc_1x1" onerror="this.src = image/item-default.png\'"></div>';a(".reverse-upload-imgs #uploadImg").before(c)}})},refundType:function(){d={id:"select-type",arr:[{name:"仅退款",sub:"未收到货，或与卖家协商后申请",value:1},{name:"退货退款",sub:"已收到货，需要将商品退还商家",value:2}]},b.selectFloat(d,function(b){var c=(a(b).text(),a(b).attr("data-value"));g.obj.refundType!==c&&(a("#refund-type .reverse-panel-right").html(d.arr[c-1].name+'<img src="image/to-right.png" class="reverse-panel-right-arrow">'),g.obj.refundType=c,a("#select-type").hide(),g.clearGoodsPanel(),1==c?(a("#refund-goods").show(),g.goodsType(1),g.hasPaibi&&a("#refund-pcoin").addClass("hide")):(a("#refund-goods").hide(),g.reasonType(3),g.hasPaibi&&a("#refund-pcoin").removeClass("hide")))}),a("#refund-type").data("events")&&a("#refund-type").data("events").click||a("#refund-type").bind("click",function(){a("#select-type").show()})},goodsType:function(c){switch(c){case 1:e={id:"select-goods",arr:[{name:"已收到货",value:1},{name:"未收到货",value:2}]}}b.selectFloat(e,function(b){var c=a(b).text(),d=a(b).attr("data-value");g.obj.refundGoodsType!==d&&(a("#refund-goods .reverse-panel-right").html(c+'<img src="image/to-right.png" class="reverse-panel-right-arrow">'),g.obj.refundGoodsType=d,a("#select-goods").hide(),g.clearReasonPanel(),2==d?g.reasonType(2):g.reasonType(3))}),a("#refund-goods").data("events")&&a("#refund-goods").data("events").click||a("#refund-goods").bind("click",function(){a("#select-goods").show()})},reasonType:function(c){switch(c){case 1:f={id:"select-reason",title:"退款原因",arr:[{name:"卖家未发货",value:12},{name:"订单信息有误",value:13},{name:"与卖家协商一致",value:14},{name:"其他",value:7}]};break;case 2:f={id:"select-reason",title:"退款原因",arr:[{name:"未按照约定时间发货",value:8},{name:"快递一直未送到",value:9},{name:"空包裹/少货",value:10},{name:"快递无跟踪记录",value:11},{name:"其他",value:7}]};break;case 3:f={id:"select-reason",title:"退款原因",arr:[{name:"收到商品描述不符",value:1},{name:"商品质量问题",value:2},{name:"收到商品少件/破损/污渍等",value:3},{name:"数码商品屏幕问题",value:4},{name:"尺寸容量与商品描述不符",value:5},{name:"卖家发错货",value:6},{name:"其他",value:7}]}}b.selectFloat(f,function(b){var c=a(b).text(),d=a(b).attr("data-value");a("#refund-reason .reverse-panel-right").html(c+'<img src="image/to-right.png" class="reverse-panel-right-arrow">'),g.obj.refundReasonType=d,a("#select-reason").hide()}),a("#refund-reason").data("events")&&a("#refund-reason").data("events").click||a("#refund-reason").bind("click",function(){return g.localObj.dealState>2&&1==g.obj.refundType&&!g.obj.refundGoodsType&&102!=g.localObj.dealState?void b.lightToast("请先选择货物状态"):void a("#select-reason").show()})},clearGoodsPanel:function(){a("#refund-goods .reverse-panel-right").html('请选择<img src="image/to-right.png" class="reverse-panel-right-arrow">'),g.obj.refundGoodsType="",g.clearReasonPanel()},clearReasonPanel:function(){a("#refund-reason .reverse-panel-right").html('请选择退款原因<img src="image/to-right.png" class="reverse-panel-right-arrow">'),g.obj.refundReasonType=""},initBindMoneyInput:function(){a("#refund-money input").bind("keyup",function(){var b=/^[0-9]\d*\.{0,1}\d{0,2}$/,c=a(this).val();a(".money-hide").text(c),b.test(c)?(g.obj.refundToBuyer=c,a(".money-sign").show(),c>parseFloat(g.localObj.dealPayFeeTotal)?a("#refund-money .reverse-panel-subtitle").addClass("error").html("不可大于订单金额"+g.localObj.dealPayFeeTotal):a("#refund-money .reverse-panel-subtitle").removeClass("error").html("")):(a("#refund-money input").val(""),a("#refund-money .reverse-panel-subtitle").removeClass("error").html(""),a(".money-sign").hide(),g.obj.refundToBuyer=0),a(".money-hide").text(a("#refund-money input").val());var d=a(".money-hide").width();a("#refund-money input").width(d?d+5:"115")})},initBindRemark:function(){b.changeLength(".reverse-remark-textarea",300,function(a){g.obj.refundReasonDesc=a})},initBindSubmit:function(){a("#apply-refund").bind("click",function(){var c=g.obj;if(c.refundType)if(g.localObj.dealState>2&&1==c.refundType&&!c.refundGoodsType&&102!=g.localObj.dealState)b.lightToast("请选择货物状态");else if(c.refundReasonType)if(!c.refundToBuyer&&c.refundToBuyer<=0)b.lightToast("请填写退款金额且大于0");else if(c.refundToBuyer>parseFloat(g.localObj.dealPayFeeTotal))b.lightToast("不可大于订单金额");else{var d=[];for(var e in imgObj){if(imgObj[e].length>0&&b.checkBase64(imgObj[e]))return void b.lightToast("存在未上传完的图片");d.push(imgObj[e])}g.obj.pic=d.toString();var f="",h="";g.localObj.refundState?(f=a.extend({},c,g.editObj),h=b.getHost(1)+"/order/v1/refund/alterRefund"):(f=c,h=b.getHost(1)+"/order/v1/refund/submitRefund");var i={url:h,data:f};b.load(i).then(function(a){"0"===a.code?b.goUrl("/refundDetail.html?dealId="+g.obj.dealId):b.isNotEmpty(a.tip)&&b.lightToast(a.tip)},function(a){b.lightToast("网络出错，请稍后再试！")})}else b.lightToast("请选择退款原因");else b.lightToast("请选择退货服务")})}};g.init()});