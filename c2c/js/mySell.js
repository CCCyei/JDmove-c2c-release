!function(){function a(a){document.body.scrollTop=document.documentElement.scrollTop=a}function b(){return document.body.scrollTop||document.documentElement.scrollTop}var c=0;open.onclick=function(){c=b(),document.body.classList.add("dialog-open"),document.body.style.top=-c+"px",mask.style.display="block"},close.onclick=function(){mask.style.display="none",document.body.classList.remove("dialog-open"),a(c)}}(),require(["jquery","utils","dot","paipaiSDK"],function(a,b,c,d){"use strict";var e={dealId:"",dealState:"",currentPage:"",pageCount:""},f={id:"select-reason",arr:[{name:"与买家协商一致",value:1},{name:"商品无货",value:2},{name:"不想卖了",value:3},{name:"拍错/误点",value:4},{name:"其他",value:5}]};b.selectFloat(f,function(b){var c=a(b).html(),d=a(b).attr("data-value");1==e.dealState?g.cancelDeal(c,e.dealId,d):2==e.dealState&&g.cancelDeal4Refund(c,e.dealId,d)});var g={page:1,pageSize:20,isLoading:!1,isAllLoad:!1,init:function(){g.getSellList(g.page,g.pageSize),g.addScorll()},bodyScollHandler:function(){a(".reverse-dialog").is(":visible")||a(".reverse-dialog-edit").is(":visible")||a(".bGView").is(":visible")?a("body").addClass("dialog-open"):a("body").removeClass("dialog-open")},getVerityAuthUser:function(){var a={url:b.getHost()+"/jdWallet/verityAuthUser"};b.load(a).then(function(a){if(b.log("校验用户是否实名"+JSON.stringify(a)),a&&0==a.code)if(a.data&&1==a.data)g.queryCustomIdByJdPin();else{var c="/mySell.html",d=b.getParameter("sid"),e="//msc.jd.com/auth/loginpage/wcoo/toAuthPage?source=2&businessType=424&sid="+d+"&directReturnUrl="+encodeURIComponent(c);b.goUrl(e)}else b.isNotEmpty(a.tip)?b.lightToast(a.tip):b.lightToast("用户实名校验异常")},function(a){b.lightToast("网络异常，稍后重试")})},queryCustomIdByJdPin:function(){var a={url:b.getHost()+"/jdWallet/queryCustomIdByJdPin"};b.load(a).then(function(a){if(a&&0==a.code)if(a.data&&b.isNotEmpty(a.data)&&a.data.length>0){var c="/c2c/mySell.html?";b.goUrl("/deliverGoods.html?dealId="+e.dealId+"&backUrl="+encodeURIComponent(c))}else{var c="mySell.html?";b.goUrl("/bindWallet.html?backUrl="+encodeURIComponent(c))}else b.isNotEmpty(a.tip)?b.lightToast(a.tip):b.lightToast("用户未绑定钱包")},function(a){b.lightToast("网络异常，稍后重试")})},addScorll:function(){a(window).on("scroll",function(){var b=a(window).scrollTop(),c=a(window).height(),d=document.body.scrollHeight;!g.isLoading&&!g.isAllLoad&&b+c+300>d&&(g.page+=1,g.isLoading=!0,g.getSellList(g.page,g.pageSize))})},getSellList:function(c,d){var f={url:b.getHost(1)+"/order/v1/deal/getSellingHistoryList",data:{index:c,size:d}};b.load(f).then(function(c){b.log(c),"0"==c.code?c.data.result&&c.data.result.length>0?(e.currentPage=c.data.currentPage,e.pageCount=c.data.pageCount,g.renderSellListInfo(c.data.result),"wx"==b.getLoginCodeType()?(a(".ui-warning").show(),a(".ui-top>div").hide(),a(".ui-adress-edit").hide(),a(".goods").css("border-bottom","none")):a(".wx-first").css({"margin-top":"0.26652452rem"}),g.isLoading=!1,(!c.data.result||c.data.result.length<g.pageSize)&&(g.isAllLoad=!0)):1==g.page?(a(".bgview").removeClass("hide"),a(".bgview p").text("没有在售商品,赶快去发布吧～"),"ershou"==b.getAppType()&&a(".mybutton").show(),a(".one-sell").unbind("click").bind("click",function(){a(this).attr("clstag","pageclick|keycount|mySell_201801303|1"),b.setDoubleClick(function(){console.log("一键转卖"),location.href="openapp.paipai://publish/app"})}),a(".push-sell").unbind("click").bind("click",function(){a(this).attr("clstag","pageclick|keycount|mySell_201802054|1"),b.setDoubleClick(function(){console.log("发布"),location.href="openapp.paipai://c2cPublish/app"})})):b.lightToast("没有更多了"):b.isNotEmpty(c.tip)?b.lightToast(c.tip):b.lightToast("获取我卖出列表异常")},function(a){})},renderSellListInfo:function(d){d=d||[],a("body").append(c.template(a(".renderSellListInfo").text())(d)),a(".goods").click(function(){var c=a(this).attr("dealId");b.goUrl("/orderDetail.html?dealId="+c+"&refresh=no")}),3==b.getType()&&(a('.ui-edit[key="lookRefund"]').remove(),a('.ui-edit[key="comment"]').remove(),a('.ui-edit[key="lookComment"]').remove(),a('.ui-edit[key="refund"]').remove()),a(".ui-edit").unbind("click").bind("click",function(){if(e.dealState=a(this).parents(".ui-adress-edit").attr("dealState"),e.dealId=a(this).parents(".ui-adress-edit").attr("dealId"),e.key=a(this).attr("key"),"cancel"==e.key)a(this).attr("clstag","pageclick|keycount|mySell__2017081020|1"),a(".reverse-select").show();else if("remindReceive"==e.key)g.reminderDeal();else if("lookComment"==e.key)a(this).attr("clstag","pageclick|keycount|mySell__2017081020|6"),b.goUrl("/evaDetail.html?orderId="+e.dealId);else if("lookRefund"==e.key)a(this).attr("clstag","pageclick|keycount|mySell__2017081020|7"),b.goUrl("/refundDetail.html?dealId="+e.dealId);else if("comment"==e.key)a(".ui-edit").attr("clstag","pageclick|keycount|mySell__2017081020|5"),b.goUrl("/assessEdit.html?orderId="+e.dealId);else if("lookPay"==e.key)a(this).attr("clstag","pageclick|keycount|mySell__2017081020|4"),b.lightToast("下载京东金融APP，即刻查看钱款去向详情");else if("alterPrice"==e.key){a(this).attr("clstag","pageclick|keycount|mySell__2017081020|2");var c=a(this).parents(".cart-goods-group").children().find(".goods-name").text(),d=a(this).parents(".cart-goods-group").children().find(".dealPayFee").attr("dealPayFee"),f=a(this).parents(".cart-goods-group").children().find(".dealPayFee").attr("dealPayFeeShipping");f=f?parseInt(f,10):"",a(".nameStr").html(c),d>0?a("#editPriceInput").val(d):a("#editPriceInput").val(0),a("#editDeliveryPriceInput").val(f),g.changePrice(e.dealId)}else if("delivery"==e.key){a(this).attr("clstag","pageclick|keycount|mySell__2017081020|3");var h="/c2c/mySell.html?";b.goUrl("/deliverGoods.html?dealId="+e.dealId+"&backUrl="+encodeURIComponent(h))}}),a(".ui-concat").unbind("click").bind("click",function(){e.dealId=a(this).parents(".ui-adress-edit").attr("dealId");var c=a(this).html(),d=a(this).attr("sku"),f=a(this).attr("uin");if(b.log("sku"+d),b.log("uin"+f),"联系买家"==c)if(3==b.getType())b.goUrl("/chat/im?otherUin="+f+"&pid="+d);else{var g={sku:d,uin:f},h="openapp.paipai://im/app?param="+encodeURIComponent(JSON.stringify(g));location.href=h}}),a(".bGView .cancelBtn").unbind("click").bind("click",function(){a(".bGView").addClass("ui-hide"),g.bodyScollHandler()}),a(".bGView .confirmBtn").unbind("click").bind("click",function(){a(".bGView").addClass("ui-hide"),g.alterDealPrice(),g.bodyScollHandler()}),a(".bGView .clear").unbind("click").bind("click",function(){a(this).parent().find("input").val("")}),a(".changePriceView").unbind("click").bind("click",function(a){a.stopPropagation()})},changePrice:function(c){var d={url:b.getHost(1)+"/order/v1/deal/checkChangePrice",data:{dealId:c}};b.load(d).then(function(c){b.log("能不能修改价格"+JSON.stringify(c)),c&&0==c.code?(a(".bGView").removeClass("ui-hide"),g.bodyScollHandler()):c&&738==c.code?(a(".reverse-dialog-edit").show(),g.bodyScollHandler(),a(".reverse-dialog-panel-tishi").html(c.tip),a(".reverse-dialog-edit #success").click(function(){a(".reverse-dialog-edit").hide(),g.bodyScollHandler()})):b.isNotEmpty(c.tip)?b.lightToast(c.tip):b.lightToast("修改价格异常")},function(a){})},cancelDeal:function(a,c,d){var e={url:b.getHost(1)+"/order/v1/deal/cancelDeal",data:{dealId:c,closeReasonDesc:a,closeReason:d||"1",optSource:"3",machineKey:"test"}};b.load(e).then(function(a){b.log("取消订单"+JSON.stringify(a)),a&&0==a.code?location.reload():b.isNotEmpty(a.tip)?b.lightToast(a.tip):b.lightToast("取消订单异常")},function(a){})},cancelDeal4Refund:function(a,c,d){var e={url:b.getHost(1)+"/order/v1/deal/cancelDeal4Refund",data:{dealId:c,closeReasonDesc:a,closeReason:d||"1",optSource:"3",machineKey:"test"}};b.load(e).then(function(a){b.log("取消订单"+JSON.stringify(a)),a&&0==a.code?location.reload():b.isNotEmpty(a.tip)?b.lightToast(a.tip):b.lightToast("取消订单异常")},function(a){})},reminderDeal:function(){var a={url:b.getHost(1)+"/order/v1/deal/reminderDeal",data:{dealId:e.dealId}};b.load(a).then(function(a){b.log("提醒收货"+JSON.stringify(a)),a&&0==a.code?b.lightToast("已催促买家收货，请耐心等待"):b.isNotEmpty(a.tip)?b.lightToast(a.tip):b.lightToast("提醒收货异常")},function(a){})},priceFiler:function(a,c){var d=!0;return b.isEmpty(a)?(b.lightToast("价格不能为空"),d=!1):b.isEmpty(c)&&(b.lightToast("邮费不能为空"),d=!1),d},alterDealPrice:function(){var c=a("#editPriceInput").val(),d=a("#editDeliveryPriceInput").val();if(g.priceFiler(c,d)){var f={url:b.getHost(1)+"/order/v1/deal/alterDealPrice",data:{dealId:e.dealId,commodityPrice:c,commodityShippingFee:d}};b.load(f).then(function(a){b.log("修改价格"+JSON.stringify(a)),a&&0==a.code?(b.lightToast(a.tip||"价格修改成功"),setTimeout(function(){location.reload()},1500)):b.isNotEmpty(a.tip)?b.lightToast(a.tip):b.lightToast("修改价格异常")},function(a){b.lightToast("网络异常，稍后重试")})}}};g.init()});