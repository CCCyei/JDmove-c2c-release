require(["jquery","utils","dot"],function(a,b,c){var d={init:function(){if(3==b.getType())b.setLocation(function(){d.initAll()});else{var a=b.getParameter("lat"),c=b.isNotEmpty(b.getParameter("lon"))?b.getParameter("lon"):b.getParameter("lng");b.isNotEmpty(a)&&b.isNotEmpty(c)?(b.setCookie("lat",a),b.setCookie("lon",c)):(b.setCookie("lat",-1),b.setCookie("lon",-1)),d.initAll()}},initAll:function(){d.addClick();var c={key1:""};b.isNotEmpty(b.getCookie("lat"))&&b.isNotEmpty(b.getCookie("lon"))&&-1!=b.getCookie("lat")&&-1!=b.getCookie("lon")?(c.key1="附近的集市",d.para.lat=Number(b.getCookie("lat")),d.para.lon=Number(b.getCookie("lon")),d.getCircleInfo()):(c.key1="推荐集市",d.para.lat=-1,d.para.lon=-1,d.getCircleInfo()),document.title=c.key1;var e=a("body"),f=a('<iframe src="//www.jd.com/favicon.ico" style="display:none;"></iframe>');f.on("load",function(){setTimeout(function(){f.off("load").remove()},0)}).appendTo(e)},num:1,tempNum:0,para:{circleId:"",lat:"",lon:"",pageSize:20,page:1},addClick:function(){a(".circle-item").unbind("click").bind("click",function(){d.para.circleId=a(this).attr("circleId");var c="";c+=d.para.lat?"&lat="+d.para.lat:"",c+=d.para.lon?"&lon="+d.para.lon:"",b.goUrl("/circleDetail.html?circleId="+d.para.circleId+c)})},setScrollView:function(){a(window).scroll(function(){var c=a(this).scrollTop(),e=a(document).height(),f=a(this).height();if(c+f>=e)if(b.isNotEmpty(b.getCookie("lat"))){if(d.num==d.tempNum)return;d.tempNum=d.num,d.getCircleInfo(d.num)}else d.num=1,d.getCircleInfo(d.num)})},renderCircleInfo:function(b){b=b||[],a(".circle-Info").append(c.template(a(".circleInfo").text())(b)),d.addClick()},getCircleInfo:function(c){var e={url:b.getHost()+"/searchCircle/nearbyCircleList",data:{pageIndex:c,pageSize:d.para.pageSize,lat:d.para.lat,lon:d.para.lon}};b.load(e).then(function(c){b.isNotEmpty(c)&&"0"==c.code&&(a(".bgview").addClass("hide"),c.data.circleList&&c.data.circleList.length>0?(d.para.page=Math.ceil(c.data.totalCount/20),d.num++,d.renderCircleInfo(c.data.circleList),d.setScrollView()):0==a(".circle-item").length?(a(".bgview").removeClass("hide"),a(".bgview p").text("附近暂时还没有集市哦~")):b.lightToast("没有更多了"))},function(b){a(".bgview").removeClass("hide"),a(".bgview p").text("数据加载失败，请点击刷新~"),a(".bgview").unbind("click").bind("click",function(){d.initAll()})})}};d.init()});